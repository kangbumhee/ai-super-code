(function(){(()=>{const i={userMessage:".conversation-statement.user .content",userMessageFallbacks:[".conversation-item-desc.user",".conversation-statement.user .bubble",".conversation-statement.user"],assistantMessage:".conversation-statement.assistant .content",assistantMessageFallbacks:[".conversation-item-desc.assistant",".conversation-statement.assistant .bubble",".conversation-statement.assistant"],chatContainer:".conversation-content",chatContainerFallbacks:[".conversation-wrapper",".chat-wrapper",".general-chat-wrapper"],inputArea:"textarea.j-search-input",sendButton:".enter-icon-wrapper",stopButton:".stop-generation-btn"};let d=0,f=!1,m=!1,a=!0,u=null,p=null;function y(e,t){let n=document.querySelector(e);if(n)return n;if(t){for(const o of t)if(n=document.querySelector(o),n)return n}return null}function O(e,t){let n=Array.from(document.querySelectorAll(e));if(n.length>0)return n;if(t){for(const o of t)if(n=Array.from(document.querySelectorAll(o)),n.length>0)return n}return[]}function E(){if(document.getElementById("omnicoder-badge"))return;const e=document.createElement("div");e.id="omnicoder-badge",e.innerHTML=`
      <div style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999999;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        padding: 8px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        gap: 6px;
        user-select: none;
        transition: opacity 0.2s;
      " id="omnicoder-badge-inner">
        <span id="omnicoder-dot" style="
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: #22c55e;
          display: inline-block;
        "></span>
        <span id="omnicoder-text">OmniCoder 감시 중</span>
      </div>
    `,document.body.appendChild(e);const t=document.getElementById("omnicoder-badge-inner");if(t){t.addEventListener("click",()=>{a=!a;const r=document.getElementById("omnicoder-dot"),l=document.getElementById("omnicoder-text");r&&(r.style.background=a?"#22c55e":"#ef4444"),l&&(l.textContent=a?"OmniCoder 감시 중":"OmniCoder 꺼짐")});let n=!1,o=0,s=0;t.addEventListener("mousedown",r=>{n=!0,o=r.clientX-t.getBoundingClientRect().left,s=r.clientY-t.getBoundingClientRect().top}),document.addEventListener("mousemove",r=>{n&&(t.style.position="fixed",t.style.left=`${r.clientX-o}px`,t.style.top=`${r.clientY-s}px`,t.style.right="auto",t.style.bottom="auto")}),document.addEventListener("mouseup",()=>{n=!1})}}function C(){const e=O(i.userMessage,i.userMessageFallbacks),t=O(i.assistantMessage,i.assistantMessageFallbacks);if(e.length===0||t.length===0)return null;const n=e[e.length-1],o=t[t.length-1],s=(n.textContent||"").trim(),r=(o.textContent||"").trim().replace(/\n?추가 작업\s*$/,"").trim();if(!s||!r)return null;const l=e.length+t.length;return{userMessage:s,claudeResponse:r,timestamp:Date.now(),messageCount:l}}function M(){const e=y(i.stopButton);if(!e)return!1;const t=window.getComputedStyle(e);return t.display!=="none"&&t.visibility!=="hidden"}function k(){return!M()}function w(){if(!a)return;const e=C();if(!e)return;const t=e.messageCount;if(t<=d)return;d=t,console.log("[OmniCoder] 새 대화 감지:",{user:e.userMessage.slice(0,60),assistant:e.claudeResponse.slice(0,60),count:t});const n=document.getElementById("omnicoder-text");n&&(n.textContent="감지됨!",setTimeout(()=>{n&&(n.textContent="OmniCoder 감시 중")},2e3)),chrome.runtime.sendMessage({type:"NEW_CHAT_DETECTED",data:{userMessage:e.userMessage,claudeResponse:e.claudeResponse,timestamp:e.timestamp,messageCount:e.messageCount}},o=>{if(chrome.runtime.lastError){console.warn("[OmniCoder] sendMessage error:",chrome.runtime.lastError.message);return}console.log("[OmniCoder] Background 응답:",o)})}let b=null;function L(){b&&clearTimeout(b),b=setTimeout(()=>{k()||!M()?(f=!1,m&&(m=!1,w())):L()},1500)}function S(){const t=y(i.chatContainer,i.chatContainerFallbacks)||document.querySelector("main")||document.body;u=new MutationObserver(n=>{var o,s,r,l;if(a)for(const g of n){if(g.type==="childList"&&g.addedNodes.length>0)for(const c of Array.from(g.addedNodes))c instanceof HTMLElement&&((o=c.classList)!=null&&o.contains("conversation-statement")||(s=c.querySelector)!=null&&s.call(c,".conversation-statement"))&&((r=c.classList)!=null&&r.contains("assistant")||(l=c.querySelector)!=null&&l.call(c,".conversation-statement.assistant"))&&(f=!0,m=!0);(g.type==="characterData"||g.type==="childList")&&f&&m&&L()}}),u.observe(t,{childList:!0,subtree:!0,characterData:!0}),console.log("[OmniCoder] Observer 시작, 타겟:",t.className||t.tagName)}function T(){p=setInterval(()=>{if(!a)return;const e=C();e&&e.messageCount>d&&k()&&w()},5e3)}chrome.runtime.onMessage.addListener(e=>{if(e.type==="MONITOR_STATUS"){const{isMonitoring:t}=e.data;a=t;const n=document.getElementById("omnicoder-dot"),o=document.getElementById("omnicoder-text");n&&(n.style.background=a?"#22c55e":"#ef4444"),o&&(o.textContent=a?"OmniCoder 감시 중":"OmniCoder 꺼짐")}});function I(){try{chrome.storage.sync.get("omnicoder_settings",e=>{var n;const t=(n=e==null?void 0:e.omnicoder_settings)==null?void 0:n.selectorOverrides;if(t&&typeof t=="object")for(const[o,s]of Object.entries(t))o in i&&typeof s=="string"&&(i[o]=s,console.log(`[OmniCoder] 셀렉터 오버라이드: ${o} = ${s}`))})}catch(e){console.warn("[OmniCoder] 셀렉터 오버라이드 로드 실패:",e)}}function v(){setTimeout(()=>{try{chrome.storage.sync.get("omnicoder_settings",e=>{var o;const t=(o=e==null?void 0:e.omnicoder_settings)==null?void 0:o.gensparkCookies;if(!t)return;if(document.querySelectorAll('[class*="avatar"], [class*="profile"], [class*="user-info"], [class*="account"]').length>0){console.log("[OmniCoder] Genspark 이미 로그인됨");return}try{const s=JSON.parse(t);Array.isArray(s)&&s.length>0&&chrome.runtime.sendMessage({type:"GENSPARK_LOGIN",data:{cookies:s}},r=>{r!=null&&r.success&&(console.log("[OmniCoder] Genspark 쿠키 설정 완료"),setTimeout(()=>location.reload(),1500))})}catch(s){console.warn("[OmniCoder] 쿠키 파싱 실패:",s)}})}catch(e){console.warn("[OmniCoder] 로그인 시도 실패:",e)}},2e3)}function x(){console.log("[OmniCoder] Genspark 모니터 초기화 시작");const e=setInterval(()=>{const t=y(i.chatContainer,i.chatContainerFallbacks);if(!window.location.pathname.startsWith("/agents")){clearInterval(e),v();return}if(t||document.querySelector(".chat-wrapper")){clearInterval(e),console.log("[OmniCoder] 채팅 컨테이너 발견"),E(),I(),S(),T(),v();const n=C();n&&(d=n.messageCount,console.log("[OmniCoder] 초기 메시지 수:",d))}},1e3);setTimeout(()=>{clearInterval(e),u||(console.log("[OmniCoder] 30초 타임아웃 — 강제 시작"),E(),I(),S(),T(),v())},3e4)}let h=location.href;new MutationObserver(()=>{location.href!==h&&(h=location.href,console.log("[OmniCoder] URL 변경 감지:",h),u&&(u.disconnect(),u=null),p&&(clearInterval(p),p=null),d=0,f=!1,m=!1,h.includes("/agents")&&setTimeout(x,1e3))}).observe(document.body,{childList:!0,subtree:!0}),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",x):x()})();
})()
