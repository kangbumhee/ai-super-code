var B=Object.defineProperty;var z=(l,t,e)=>t in l?B(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var L=(l,t,e)=>z(l,typeof t!="symbol"?t+"":t,e);import{g as W,D as F,M as v}from"./index-BDcumJnu.js";var q={exports:{}},G;function H(){return G||(G=1,(function(l){var t=(function(){var e=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",i={};function g(o,c){if(!i[o]){i[o]={};for(var r=0;r<o.length;r++)i[o][o.charAt(r)]=r}return i[o][c]}var a={compressToBase64:function(o){if(o==null)return"";var c=a._compress(o,6,function(r){return n.charAt(r)});switch(c.length%4){default:case 0:return c;case 1:return c+"===";case 2:return c+"==";case 3:return c+"="}},decompressFromBase64:function(o){return o==null?"":o==""?null:a._decompress(o.length,32,function(c){return g(n,o.charAt(c))})},compressToUTF16:function(o){return o==null?"":a._compress(o,15,function(c){return e(c+32)})+" "},decompressFromUTF16:function(o){return o==null?"":o==""?null:a._decompress(o.length,16384,function(c){return o.charCodeAt(c)-32})},compressToUint8Array:function(o){for(var c=a.compress(o),r=new Uint8Array(c.length*2),d=0,h=c.length;d<h;d++){var x=c.charCodeAt(d);r[d*2]=x>>>8,r[d*2+1]=x%256}return r},decompressFromUint8Array:function(o){if(o==null)return a.decompress(o);for(var c=new Array(o.length/2),r=0,d=c.length;r<d;r++)c[r]=o[r*2]*256+o[r*2+1];var h=[];return c.forEach(function(x){h.push(e(x))}),a.decompress(h.join(""))},compressToEncodedURIComponent:function(o){return o==null?"":a._compress(o,6,function(c){return s.charAt(c)})},decompressFromEncodedURIComponent:function(o){return o==null?"":o==""?null:(o=o.replace(/ /g,"+"),a._decompress(o.length,32,function(c){return g(s,o.charAt(c))}))},compress:function(o){return a._compress(o,16,function(c){return e(c)})},_compress:function(o,c,r){if(o==null)return"";var d,h,x={},_={},A="",I="",k="",M=2,S=3,y=2,T=[],u=0,m=0,f;for(f=0;f<o.length;f+=1)if(A=o.charAt(f),Object.prototype.hasOwnProperty.call(x,A)||(x[A]=S++,_[A]=!0),I=k+A,Object.prototype.hasOwnProperty.call(x,I))k=I;else{if(Object.prototype.hasOwnProperty.call(_,k)){if(k.charCodeAt(0)<256){for(d=0;d<y;d++)u=u<<1,m==c-1?(m=0,T.push(r(u)),u=0):m++;for(h=k.charCodeAt(0),d=0;d<8;d++)u=u<<1|h&1,m==c-1?(m=0,T.push(r(u)),u=0):m++,h=h>>1}else{for(h=1,d=0;d<y;d++)u=u<<1|h,m==c-1?(m=0,T.push(r(u)),u=0):m++,h=0;for(h=k.charCodeAt(0),d=0;d<16;d++)u=u<<1|h&1,m==c-1?(m=0,T.push(r(u)),u=0):m++,h=h>>1}M--,M==0&&(M=Math.pow(2,y),y++),delete _[k]}else for(h=x[k],d=0;d<y;d++)u=u<<1|h&1,m==c-1?(m=0,T.push(r(u)),u=0):m++,h=h>>1;M--,M==0&&(M=Math.pow(2,y),y++),x[I]=S++,k=String(A)}if(k!==""){if(Object.prototype.hasOwnProperty.call(_,k)){if(k.charCodeAt(0)<256){for(d=0;d<y;d++)u=u<<1,m==c-1?(m=0,T.push(r(u)),u=0):m++;for(h=k.charCodeAt(0),d=0;d<8;d++)u=u<<1|h&1,m==c-1?(m=0,T.push(r(u)),u=0):m++,h=h>>1}else{for(h=1,d=0;d<y;d++)u=u<<1|h,m==c-1?(m=0,T.push(r(u)),u=0):m++,h=0;for(h=k.charCodeAt(0),d=0;d<16;d++)u=u<<1|h&1,m==c-1?(m=0,T.push(r(u)),u=0):m++,h=h>>1}M--,M==0&&(M=Math.pow(2,y),y++),delete _[k]}else for(h=x[k],d=0;d<y;d++)u=u<<1|h&1,m==c-1?(m=0,T.push(r(u)),u=0):m++,h=h>>1;M--,M==0&&(M=Math.pow(2,y),y++)}for(h=2,d=0;d<y;d++)u=u<<1|h&1,m==c-1?(m=0,T.push(r(u)),u=0):m++,h=h>>1;for(;;)if(u=u<<1,m==c-1){T.push(r(u));break}else m++;return T.join("")},decompress:function(o){return o==null?"":o==""?null:a._decompress(o.length,32768,function(c){return o.charCodeAt(c)})},_decompress:function(o,c,r){var d=[],h=4,x=4,_=3,A="",I=[],k,M,S,y,T,u,m,f={val:r(0),position:c,index:1};for(k=0;k<3;k+=1)d[k]=k;for(S=0,T=Math.pow(2,2),u=1;u!=T;)y=f.val&f.position,f.position>>=1,f.position==0&&(f.position=c,f.val=r(f.index++)),S|=(y>0?1:0)*u,u<<=1;switch(S){case 0:for(S=0,T=Math.pow(2,8),u=1;u!=T;)y=f.val&f.position,f.position>>=1,f.position==0&&(f.position=c,f.val=r(f.index++)),S|=(y>0?1:0)*u,u<<=1;m=e(S);break;case 1:for(S=0,T=Math.pow(2,16),u=1;u!=T;)y=f.val&f.position,f.position>>=1,f.position==0&&(f.position=c,f.val=r(f.index++)),S|=(y>0?1:0)*u,u<<=1;m=e(S);break;case 2:return""}for(d[3]=m,M=m,I.push(m);;){if(f.index>o)return"";for(S=0,T=Math.pow(2,_),u=1;u!=T;)y=f.val&f.position,f.position>>=1,f.position==0&&(f.position=c,f.val=r(f.index++)),S|=(y>0?1:0)*u,u<<=1;switch(m=S){case 0:for(S=0,T=Math.pow(2,8),u=1;u!=T;)y=f.val&f.position,f.position>>=1,f.position==0&&(f.position=c,f.val=r(f.index++)),S|=(y>0?1:0)*u,u<<=1;d[x++]=e(S),m=x-1,h--;break;case 1:for(S=0,T=Math.pow(2,16),u=1;u!=T;)y=f.val&f.position,f.position>>=1,f.position==0&&(f.position=c,f.val=r(f.index++)),S|=(y>0?1:0)*u,u<<=1;d[x++]=e(S),m=x-1,h--;break;case 2:return I.join("")}if(h==0&&(h=Math.pow(2,_),_++),d[m])A=d[m];else if(m===x)A=M+M.charAt(0);else return null;I.push(A),d[x++]=M+A.charAt(0),h--,M=A,h==0&&(h=Math.pow(2,_),_++)}}};return a})();l!=null?l.exports=t:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return t})})(q)),q.exports}var Q=H();const J=W(Q),b={settings:"omnicoder_settings",tasks:"omnicoder_tasks",logs:"omnicoder_logs",files:"omnicoder_files",costs:"omnicoder_costs"};class p{static async getSync(t){return(await chrome.storage.sync.get(t))[t]??null}static async setSync(t,e){await chrome.storage.sync.set({[t]:e})}static async getLocal(t){return(await chrome.storage.local.get(t))[t]??null}static async setLocal(t,e){await chrome.storage.local.set({[t]:e})}static async setCompressed(t,e){const n=J.compress(JSON.stringify(e));await this.setLocal(t,n)}static async getCompressed(t){const e=await this.getLocal(t);if(!e)return null;try{const n=J.decompress(e);return n?JSON.parse(n):null}catch{return null}}static async getSettings(){const t=await this.getSync(b.settings);return{...F,...t}}static async saveSettings(t){const e=await this.getSettings();await this.setSync(b.settings,{...e,...t})}static async getTasks(){return await this.getCompressed(b.tasks)||[]}static async saveTasks(t){await this.setCompressed(b.tasks,t)}static async addTask(t){const e=await this.getTasks();e.push(t),await this.saveTasks(e)}static async updateTask(t,e){const n=await this.getTasks(),s=n.findIndex(i=>i.id===t);s!==-1&&(n[s]={...n[s],...e},await this.saveTasks(n))}static async getLogs(){return await this.getCompressed(b.logs)||[]}static async saveLogs(t){await this.setCompressed(b.logs,t)}static async addLog(t){const e=await this.getLogs();e.push(t),await this.saveLogs(e)}static async updateLog(t,e){const n=await this.getLogs(),s=n.findIndex(i=>i.id===t);s!==-1&&(n[s]={...n[s],...e},await this.saveLogs(n))}static async getFiles(){return await this.getCompressed(b.files)||{}}static async saveFiles(t){await this.setCompressed(b.files,t)}static async mergeFiles(t){const e=await this.getFiles();await this.saveFiles({...e,...t})}static async getCosts(){return await this.getLocal(b.costs)||[]}static async addCost(t){const e=await this.getCosts();e.push(t),await this.setLocal(b.costs,e)}static async clearAll(){await chrome.storage.local.clear(),await chrome.storage.sync.clear()}static async exportAll(){const[t,e,n,s,i]=await Promise.all([this.getSettings(),this.getTasks(),this.getLogs(),this.getFiles(),this.getCosts()]);return JSON.stringify({settings:t,tasks:e,logs:n,files:s,costs:i,exportedAt:new Date().toISOString()},null,2)}static async importAll(t){const e=JSON.parse(t);e.settings&&await this.saveSettings(e.settings),e.tasks&&await this.saveTasks(e.tasks),e.logs&&await this.saveLogs(e.logs),e.files&&await this.saveFiles(e.files),e.costs&&await this.setLocal(b.costs,e.costs)}static async cleanup(t){const e=await this.getLogs(),n=Date.now()-t*864e5,s=e.filter(g=>new Date(g.timestamp).getTime()>n),i=e.length-s.length;return await this.saveLogs(s),i}}class C{constructor(t){L(this,"apiKey");this.apiKey=t}setApiKey(t){this.apiKey=t}async call(t,e=3){var i;if(!this.apiKey)throw new Error("API key is not set");const n={model:t.model,max_tokens:t.maxTokens||8e3,system:t.system,messages:t.messages};let s=null;for(let g=0;g<=e;g++)try{const a=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify(n)});if(a.status===401||a.status===400){const c=await a.json().catch(()=>({}));throw new Error(`API Error ${a.status}: ${((i=c.error)==null?void 0:i.message)||a.statusText}`)}if(a.status===429||a.status===529||a.status>=500){const c=Math.min(6e4,1e3*Math.pow(2,g));await new Promise(r=>setTimeout(r,c)),s=new Error(`API Error ${a.status}`);continue}if(!a.ok)throw new Error(`API Error ${a.status}: ${a.statusText}`);return await a.json()}catch(a){if(a instanceof Error&&(a.message.includes("401")||a.message.includes("400")))throw a;if(s=a instanceof Error?a:new Error(String(a)),g<e){const o=Math.min(6e4,1e3*Math.pow(2,g));await new Promise(c=>setTimeout(c,o))}}throw s||new Error("API call failed after retries")}static calculateCost(t,e,n){return t/1e6*n.inputPer1M+e/1e6*n.outputPer1M}static getModelTier(t){return v.find(e=>e.id===t)||v[0]}static createCostEntry(t,e,n){const s=C.getModelTier(e),i=C.calculateCost(t.usage.input_tokens,t.usage.output_tokens,s);return{timestamp:Date.now(),model:e,inputTokens:t.usage.input_tokens,outputTokens:t.usage.output_tokens,cost:i,taskId:n}}async testConnection(){try{return await this.call({model:v[0].id,system:"Reply OK.",messages:[{role:"user",content:"ping"}],maxTokens:16},0),{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:String(t)}}}}const Y={critical:0,high:1,medium:2,low:3};class X{constructor(t=3){L(this,"maxConcurrent");L(this,"runningCount",0);L(this,"onTaskReady",null);this.maxConcurrent=t}onReady(t){this.onTaskReady=t}async enqueue(t,e){const n={id:`task_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,type:(e==null?void 0:e.type)||"code_generation",priority:(e==null?void 0:e.priority)||"medium",status:"pending",input:t,output:null,retryCount:0,maxRetries:(e==null?void 0:e.maxRetries)??5,currentModelIndex:(e==null?void 0:e.modelIndex)??0,createdAt:Date.now(),startedAt:null,completedAt:null,error:null,retryHistory:[],parentTaskId:(e==null?void 0:e.parentTaskId)??null,childTaskIds:[]};return await p.addTask(n),n}async dequeue(){if(this.runningCount>=this.maxConcurrent)return null;const e=(await p.getTasks()).filter(s=>s.status==="pending"||s.status==="queued").sort((s,i)=>{const g=Y[s.priority]??2,a=Y[i.priority]??2;return g!==a?g-a:s.createdAt-i.createdAt});if(e.length===0)return null;const n=e[0];return this.runningCount++,await p.updateTask(n.id,{status:"running",startedAt:Date.now()}),{...n,status:"running",startedAt:Date.now()}}async updateStatus(t,e,n){const s={status:e,...n};(e==="completed"||e==="failed")&&(s.completedAt=Date.now(),this.runningCount=Math.max(0,this.runningCount-1)),await p.updateTask(t,s)}async retry(t,e,n=!0){this.runningCount=Math.max(0,this.runningCount-1);const i=(await p.getTasks()).find(o=>o.id===t);if(!i)return;if(i.retryCount>=i.maxRetries){await p.updateTask(t,{status:"failed",error:e,completedAt:Date.now()});return}let g=i.currentModelIndex;n&&g<3&&g++;const a={attempt:i.retryCount+1,model:v[Math.min(i.currentModelIndex,v.length-1)].id,error:e,timestamp:Date.now()};await p.updateTask(t,{status:"pending",retryCount:i.retryCount+1,currentModelIndex:g,retryHistory:[...i.retryHistory,a],startedAt:null,completedAt:null,error:null})}async cancel(t){this.runningCount=Math.max(0,this.runningCount-1),await p.updateTask(t,{status:"skipped",error:"사용자 취소",completedAt:Date.now()})}async release(t){this.runningCount=Math.max(0,this.runningCount-1),await p.updateTask(t,{status:"pending"})}async createSubTask(t,e,n){const s=await this.enqueue(e,{type:n,parentTaskId:t}),g=(await p.getTasks()).find(a=>a.id===t);return g&&await p.updateTask(t,{childTaskIds:[...g.childTaskIds,s.id]}),s}async processQueue(){if(!this.onTaskReady)return;let t=await this.dequeue();for(;t;){try{await this.onTaskReady(t)}catch(e){await this.retry(t.id,e instanceof Error?e.message:String(e))}t=await this.dequeue()}}async getStats(){const t=await p.getTasks();return{total:t.length,pending:t.filter(e=>e.status==="pending"||e.status==="queued").length,running:t.filter(e=>e.status==="running").length,completed:t.filter(e=>e.status==="completed").length,failed:t.filter(e=>e.status==="failed").length}}async reorderTask(t,e){await p.updateTask(t,{priority:e})}}const Z=`You are a senior full-stack developer. Given a user request and an architect's design, produce working code.
Respond ONLY with a JSON object:
{
  "summary": "brief description",
  "is_coding_task": true/false,
  "files": [{ "path": "...", "content": "...", "action": "create|modify|delete", "language": "..." }],
  "commands": ["npm install ...", ...],
  "git_message": "feat: ...",
  "questions": "any clarification needed or null"
}`,V=`You are a code reviewer. Analyze the provided code for bugs, security issues, and best practices.
Respond ONLY with JSON:
{
  "score": 0-100,
  "passed": true/false,
  "issues": [{ "severity": "critical|major|minor", "file": "...", "line": 0, "description": "...", "fix": "..." }],
  "summary": "..."
}
Score >= 70 means passed = true.`,tt=`You are a QA engineer. Write vitest test files for the provided code.
Respond ONLY with JSON:
{
  "test_files": [{ "path": "...", "content": "...", "covers": ["file1.ts", "file2.ts"] }],
  "summary": "..."
}`,et=`You are a debugging expert. Given code and error list, fix all issues.
Respond ONLY with JSON:
{
  "root_cause": "...",
  "files": [{ "path": "...", "content": "...", "action": "modify" }],
  "changes_made": "...",
  "git_message": "fix: ..."
}`;function st(l,t,e){const n=Object.entries(e).map(([s,i])=>`--- ${s} ---
${i}`).join(`

`);return`## 사용자 요청
${l}

## 아키텍트 설계
${t}

## 기존 파일
${n||"(없음)"}

위 설계를 바탕으로 코드를 구현하세요. 반드시 JSON으로만 응답하세요.`}function at(l){return`다음 코드를 리뷰하세요:

${Object.entries(l).map(([e,n])=>`--- ${e} ---
${n}`).join(`

`)}`}function nt(l){return`다음 코드에 대한 vitest 테스트를 작성하세요:

${Object.entries(l).map(([e,n])=>`--- ${e} ---
${n}`).join(`

`)}`}function it(l,t){const e=Object.entries(l).map(([n,s])=>`--- ${n} ---
${s}`).join(`

`);return`## 에러 목록
${t.map((n,s)=>`${s+1}. ${n}`).join(`
`)}

## 현재 코드
${e}

위 에러를 모두 수정하세요.`}const rt={maxIterations:10,reviewThreshold:70,autoUpgrade:!0};class ot{constructor(t,e){L(this,"client");L(this,"config");L(this,"costEntries",[]);this.client=new C(t),this.config={...rt,...e}}updateApiKey(t){this.client.setApiKey(t)}async execute(t){let e=t.currentModelIndex;const n={...t.input.existingFiles};this.costEntries=[];for(let s=1;s<=this.config.maxIterations;s++){const i=v[Math.min(e,v.length-1)].id;this.emitProgress(t.id,s,"coder",i,`코드 생성 중 (반복 ${s})`);let g;try{g=await this.runCoder(t,n,i)}catch(r){if(this.config.autoUpgrade&&e<v.length-1){e++;continue}throw r}if(!g.isCodingTask)return{summary:g.summary||"비코딩 응답",files:[],commands:[],gitMessage:"",cost:this.totalCost(),model:i,isCodingTask:!1,questions:g.questions};for(const r of g.files)r.action==="delete"?delete n[r.path]:n[r.path]=r.content;this.emitProgress(t.id,s,"reviewer",i,"코드 리뷰 중");let a;try{const r=v[0].id;a=await this.runReviewer(n,r,t.id)}catch{a={score:80,passed:!0,issues:[],summary:"리뷰 스킵"}}if(!a.passed){const r=a.issues.map(d=>`[${d.severity}] ${d.file}: ${d.description}`).join(`
`);t={...t,input:{...t.input,claudeResponse:t.input.claudeResponse+`

리뷰 이슈:
`+r}};continue}this.emitProgress(t.id,s,"tester",i,"테스트 생성 중");try{const r=await this.runTester(n,i,t.id);for(const d of r)n[d.path]=d.content}catch{}this.emitProgress(t.id,s,"analyzer",i,"정적 분석 중");const o=this.staticAnalysis(n);if(o.length>0){this.emitProgress(t.id,s,"debugger",i,"에러 수정 중");try{const r=await this.runDebugger(n,o,i,t.id);for(const d of r)n[d.path]=d.content}catch{}continue}const c=Object.entries(n).map(([r,d])=>({path:r,content:d,action:"create",language:this.detectLanguage(r)}));return this.emitProgress(t.id,s,"complete",i,"완료!",c),{summary:g.summary,files:c,commands:g.commands,gitMessage:g.gitMessage,cost:this.totalCost(),model:i,isCodingTask:!0,questions:null}}throw new Error(`최대 반복 횟수(${this.config.maxIterations}) 초과`)}async runCoder(t,e,n){var c;const s=st(t.input.userMessage,t.input.claudeResponse,e),i=await this.client.call({model:n,system:Z,messages:[{role:"user",content:s}]});this.costEntries.push(C.createCostEntry(i,n,t.id));const g=((c=i.content[0])==null?void 0:c.text)||"",a=this.parseJSON(g),o=(a==null?void 0:a.files)||[];return{isCodingTask:(a==null?void 0:a.is_coding_task)??!0,summary:(a==null?void 0:a.summary)||"코드 생성 완료",files:o.map(r=>({path:r.path,content:r.content,action:r.action||"create",language:r.language||this.detectLanguage(r.path)})),commands:(a==null?void 0:a.commands)||[],gitMessage:(a==null?void 0:a.git_message)||"",questions:(a==null?void 0:a.questions)??null}}async runReviewer(t,e,n){var c;const s=at(t),i=await this.client.call({model:e,system:V,messages:[{role:"user",content:s}]});this.costEntries.push(C.createCostEntry(i,e,n));const g=((c=i.content[0])==null?void 0:c.text)||"",a=this.parseJSON(g),o=(a==null?void 0:a.score)??80;return{score:o,passed:(a==null?void 0:a.passed)??o>=this.config.reviewThreshold,issues:(a==null?void 0:a.issues)||[],summary:(a==null?void 0:a.summary)||""}}async runTester(t,e,n){var c;const s=nt(t),i=await this.client.call({model:e,system:tt,messages:[{role:"user",content:s}]});this.costEntries.push(C.createCostEntry(i,e,n));const g=((c=i.content[0])==null?void 0:c.text)||"",a=this.parseJSON(g);return((a==null?void 0:a.test_files)||[]).map(r=>({path:r.path,content:r.content,action:"create",language:this.detectLanguage(r.path)}))}async runDebugger(t,e,n,s){var r;const i=it(t,e),g=await this.client.call({model:n,system:et,messages:[{role:"user",content:i}]});this.costEntries.push(C.createCostEntry(g,n,s));const a=((r=g.content[0])==null?void 0:r.text)||"",o=this.parseJSON(a);return((o==null?void 0:o.files)||[]).map(d=>({path:d.path,content:d.content,action:d.action||"modify",language:this.detectLanguage(d.path)}))}parseJSON(t){const e=t.match(/```json\s*([\s\S]*?)```/);if(e)try{return JSON.parse(e[1])}catch{}const n=t.indexOf("{"),s=t.lastIndexOf("}");if(n>=0&&s>n)try{return JSON.parse(t.slice(n,s+1))}catch{}return null}staticAnalysis(t){const e=[];for(const[n,s]of Object.entries(t))if(s.trim()||e.push(`빈 파일: ${n}`),s.includes("require(")&&!n.endsWith(".cjs")&&e.push(`${n}: require() 대신 import 사용 필요`),(s.includes("TODO")||s.includes("FIXME"))&&e.push(`${n}: TODO/FIXME 미완성 코드 발견`),s.includes("console.log")&&!n.includes(".test.")&&!n.includes("__test__")&&e.push(`${n}: console.log 제거 필요`),n.endsWith(".json"))try{JSON.parse(s)}catch{e.push(`${n}: 유효하지 않은 JSON`)}return e}detectLanguage(t){var s;const e=(s=t.split(".").pop())==null?void 0:s.toLowerCase();return{ts:"typescript",tsx:"typescriptreact",js:"javascript",jsx:"javascriptreact",py:"python",json:"json",html:"html",css:"css",md:"markdown",sh:"shell"}[e||""]||"plaintext"}emitProgress(t,e,n,s,i,g){this.config.onProgress&&this.config.onProgress({taskId:t,step:e,maxSteps:this.config.maxIterations,status:i,model:s,files:g,cost:this.totalCost(),agentRole:n})}totalCost(){return this.costEntries.reduce((t,e)=>t+e.cost,0)}}let E,P,w={...F},$=!1,D=!1;async function N(){const[l,t,e,n]=await Promise.all([p.getTasks(),p.getCosts(),p.getFiles(),p.getLogs()]),s=new Date;s.setHours(0,0,0,0);const i=s.getTime();return{isMonitoring:w.isMonitoring??!1,executionMode:w.executionMode,currentModelIndex:w.defaultModelIndex,tasks:l,conversationLogs:n,projectFiles:e,costHistory:t,totalCost:t.reduce((g,a)=>g+a.cost,0),todayCost:t.filter(g=>g.timestamp>=i).reduce((g,a)=>g+a.cost,0),tasksQueued:l.filter(g=>g.status==="pending"||g.status==="queued").length,tasksCompleted:l.filter(g=>g.status==="completed").length,tasksFailed:l.filter(g=>g.status==="failed").length,isProcessing:D,lastActivity:null}}async function R(){if(!$)try{w=await p.getSettings(),E=new X(w.maxConcurrentTasks||3),P=new ot(w.apiKey,{maxIterations:10,reviewThreshold:70,autoUpgrade:w.autoUpgrade,onProgress:U}),$=!0,console.log("[OmniCoder] Background initialized")}catch(l){console.error("[OmniCoder] Init failed:",l)}}chrome.alarms.create("omnicoder-keepalive",{periodInMinutes:.4});chrome.alarms.create("omnicoder-process-queue",{periodInMinutes:.5});chrome.alarms.create("omnicoder-daily-cleanup",{periodInMinutes:60});chrome.alarms.onAlarm.addListener(async l=>{await R(),l.name==="omnicoder-process-queue"?await j():l.name==="omnicoder-daily-cleanup"&&await dt()});async function j(){if(!D){D=!0;try{let l=await E.dequeue();for(;l;){if(w.executionMode==="manual"&&l.status==="pending"){await E.release(l.id),l=await E.dequeue();continue}try{await ct(l)}catch(t){await E.retry(l.id,t instanceof Error?t.message:String(t))}l=await E.dequeue()}}finally{D=!1,await O()}}}async function ct(l){P.updateApiKey(w.apiKey);const t=Math.min(l.currentModelIndex,v.length-1);t!==l.currentModelIndex&&(await p.updateTask(l.id,{currentModelIndex:t}),l={...l,currentModelIndex:t}),U({taskId:l.id,step:0,maxSteps:10,status:"실행 시작",model:v[t].id,agentRole:"system"});const e=await P.execute(l);if(!e.isCodingTask){await E.updateStatus(l.id,"completed",{output:e,completedAt:Date.now()}),await O();return}const n={};for(const i of e.files)i.action!=="delete"&&(n[i.path]=i.content);await p.mergeFiles(n);const s={timestamp:Date.now(),model:e.model,inputTokens:0,outputTokens:0,cost:e.cost,taskId:l.id};await p.addCost(s),await E.updateStatus(l.id,"completed",{output:e,completedAt:Date.now()}),U({taskId:l.id,step:10,maxSteps:10,status:`완료: ${e.files.length}개 파일`,model:e.model,cost:e.cost,files:e.files,agentRole:"complete"}),w.notificationsEnabled&&K("태스크 완료",`${e.files.length}개 파일, $${e.cost.toFixed(4)}`),await O()}async function ut(l,t){const e=await p.getFiles(),n=await E.enqueue({userMessage:l,claudeResponse:t,existingFiles:e},{maxRetries:w.maxRetries,modelIndex:w.defaultModelIndex}),s={id:`log_${Date.now()}`,timestamp:new Date().toISOString(),userMessage:l,claudeResponse:t,status:"detected",taskId:n.id};if(await p.addLog(s),w.executionMode==="full_auto"&&(await p.updateTask(n.id,{status:"queued"}),j()),await O(),w.notificationsEnabled){const i=w.executionMode==="full_auto"?"자동 실행 중":"승인 대기";K("새 대화 감지",`${i}: ${l.slice(0,80)}`)}return n.id}chrome.runtime.onMessage.addListener((l,t,e)=>(R().then(()=>lt(l,e)),!0));async function lt(l,t){var n;const e=l.data;try{switch(l.type){case"NEW_CHAT_DETECTED":{const s=await ut(e==null?void 0:e.userMessage,e==null?void 0:e.claudeResponse);t({success:!0,taskId:s});break}case"APPROVE_TASK":{const s=e==null?void 0:e.taskId;await p.updateTask(s,{status:"queued"}),j(),t({success:!0});break}case"SKIP_TASK":{const s=e==null?void 0:e.taskId;await p.updateTask(s,{status:"skipped",completedAt:Date.now()}),await O(),t({success:!0});break}case"CANCEL_TASK":{const s=e==null?void 0:e.taskId;await E.cancel(s),await O(),t({success:!0});break}case"RETRY_TASK":{const s=e==null?void 0:e.taskId;(await p.getTasks()).find(a=>a.id===s)&&(await p.updateTask(s,{status:"queued",error:null,completedAt:null}),j()),t({success:!0});break}case"REORDER_TASKS":{const{taskId:s,priority:i}=e;await E.reorderTask(s,i),t({success:!0});break}case"GET_STATE":{const s=await N(),i=await E.getStats();t({success:!0,state:s,queueStats:i});break}case"GET_ALL_DATA":{const[s,i,g,a]=await Promise.all([p.getTasks(),p.getLogs(),p.getFiles(),p.getCosts()]),o=Object.entries(g).map(([r,d])=>({path:r,content:d,action:"create",language:"typescript"})),c=await N();t({success:!0,state:c,tasks:s,logs:i,files:o,costs:a,settings:w});break}case"GET_SETTINGS":{t({success:!0,settings:w});break}case"SAVE_SETTINGS":{w={...w,...e},await p.saveSettings(w),P.updateApiKey(w.apiKey),await O(),t({success:!0});break}case"TOGGLE_MONITOR":{w.isMonitoring=!w.isMonitoring,await p.saveSettings({isMonitoring:w.isMonitoring});const s=await chrome.tabs.query({url:"https://www.genspark.ai/*"});for(const i of s)i.id&&chrome.tabs.sendMessage(i.id,{type:"MONITOR_STATUS",data:{isMonitoring:w.isMonitoring}});t({success:!0,isMonitoring:w.isMonitoring});break}case"SET_EXECUTION_MODE":{const s=e.executionMode;w.executionMode=s,await p.saveSettings({executionMode:w.executionMode}),await O(),t({success:!0});break}case"SET_MODEL":{const s=e.modelIndex??v.findIndex(i=>i.id===e.modelId);s>=0&&(w.defaultModelIndex=s,await p.saveSettings({defaultModelIndex:s})),await O(),t({success:!0});break}case"TEST_API":{try{const s=(e==null?void 0:e.apiKey)||w.apiKey,g=await new C(s).testConnection();t({success:g.success,message:g.success?"API 연결 성공":g.error||"API 연결 실패"})}catch(s){t({success:!1,message:s instanceof Error?s.message:"API 테스트 실패"})}break}case"GENSPARK_LOGIN":{try{const s=e.cookies;if(!Array.isArray(s)){t({success:!1,error:"cookies array required"});break}const i=s;for(const a of i)await chrome.cookies.set({url:"https://www.genspark.ai",name:a.name,value:a.value,domain:a.domain||".genspark.ai",path:a.path||"/",secure:a.secure??!0,httpOnly:a.httpOnly??!1,expirationDate:a.expirationDate||Date.now()/1e3+86400*30});const g=await chrome.tabs.query({url:"https://www.genspark.ai/*"});for(const a of g)a.id&&chrome.tabs.reload(a.id);t({success:!0,message:"Genspark 쿠키 설정 완료"})}catch(s){t({success:!1,error:s instanceof Error?s.message:"Cookie 설정 실패"})}break}case"EXPORT_LOGS":{const s=await p.exportAll();t({success:!0,data:s});break}case"CLEAR_LOGS":{await p.saveLogs([]),await O(),t({success:!0});break}case"EXPORT_FILES":{const s=await p.getFiles(),i=Object.entries(s).map(([g,a])=>({path:g,content:a,action:"create",language:"typescript"}));t({success:!0,files:i});break}case"IMPORT_DATA":{const s=e.data;await p.importAll(typeof s=="string"?s:JSON.stringify(s)),$=!1,await R(),t({success:!0});break}case"CLEAR_DATA":{await p.clearAll(),w={...F},$=!1,await R(),await O(),t({success:!0});break}case"RUN_SELECTOR_TEST":{const s=await chrome.tabs.query({url:"https://www.genspark.ai/*"});if(s.length===0||!s[0].id){t({success:!1,error:"Genspark 탭 없음"});break}try{const i=await chrome.scripting.executeScript({target:{tabId:s[0].id},func:()=>{const g=[{name:"userMessage",sel:".conversation-statement.user .content"},{name:"userMessage (fallback)",sel:".conversation-item-desc.user"},{name:"assistantMessage",sel:".conversation-statement.assistant .content"},{name:"assistantMessage (fallback)",sel:".conversation-item-desc.assistant"},{name:"chatContainer",sel:".conversation-content"},{name:"chatContainer (fallback)",sel:".chat-wrapper"},{name:"inputArea",sel:"textarea.j-search-input"},{name:"sendButton",sel:".enter-icon-wrapper"},{name:"stopButton",sel:".stop-generation-btn"},{name:"bubble (user)",sel:".conversation-statement.user .bubble"},{name:"bubble (assistant)",sel:".conversation-statement.assistant .bubble"}],a={};for(const{name:o,sel:c}of g){const r=document.querySelectorAll(c);a[o]={found:r.length>0,count:r.length,sample:r.length>0?(r[r.length-1].textContent||"").trim().slice(0,100):""}}return a}});t({success:!0,results:((n=i==null?void 0:i[0])==null?void 0:n.result)??null})}catch(i){t({success:!1,error:i instanceof Error?i.message:"Selector test failed"})}break}case"DOWNLOAD_FILE":{const{path:s,content:i}=e,a=`data:text/plain;base64,${btoa(unescape(encodeURIComponent(i)))}`;chrome.downloads.download({url:a,filename:s.replace(/\//g,"_"),saveAs:!0}),t({success:!0});break}default:t({success:!1,error:`Unknown: ${l.type}`})}}catch(s){console.error("[OmniCoder] Message handler error:",s),t({success:!1,error:s instanceof Error?s.message:"Unknown error"})}}async function O(){const l=await N(),t=await E.getStats();chrome.runtime.sendMessage({type:"STATE_UPDATE",data:{state:l,queueStats:t}}).catch(()=>{})}function U(l){chrome.runtime.sendMessage({type:"PROGRESS_UPDATE",data:l}).catch(()=>{})}function K(l,t){chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("src/assets/icon128.png"),title:`OmniCoder: ${l}`,message:t})}async function dt(){await p.cleanup(w.autoCleanupDays)}chrome.runtime.onInstalled.addListener(async l=>{await R(),l.reason==="install"&&K("설치 완료","API 키를 설정해주세요.")});R();console.log("[OmniCoder] Background service worker loaded");chrome.action.onClicked.addListener(async()=>{const l=chrome.runtime.getURL("src/dashboard/index.html"),e=(await chrome.tabs.query({})).find(n=>{var s;return(s=n.url)==null?void 0:s.startsWith(l)});e&&e.id?(await chrome.tabs.update(e.id,{active:!0}),e.windowId&&await chrome.windows.update(e.windowId,{focused:!0})):await chrome.tabs.create({url:l})});
